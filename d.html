<!DOCTYPE html>
if (player1Loaded && !player1Broken && player1Img.complete && player1Img.naturalWidth !== 0) {
ctx.drawImage(player1Img, player1.x, player1.y, player1.w, player1.h);
} else {
drawPlaceholder(player1);
}


if (player2Loaded && !player2Broken && player2Img.complete && player2Img.naturalWidth !== 0) {
ctx.drawImage(player2Img, player2.x, player2.y, player2.w, player2.h);
} else {
drawPlaceholder(player2);
}


// Attack handling
if (player1.attacking) {
drawAttack(player1, player1.facing);
player1.attackFrame++;
if (player1.attackFrame > 30) {
player1.attacking = false;
player1.attackFrame = 0;
player2._wasHit = false; // reset hit flag
}
}


if (player2.attacking) {
drawSwordAttack(player2); // 改成劍砍擊動畫
player2.attackFrame++;
if (player2.attackFrame > 20) {
player2.attacking = false;
player2.attackFrame = 0;
player1._wasHit = false;
}
}


// draw simple HP bars
drawHpBar(player1, 20, 20);
drawHpBar(player2, canvas.width - 220, 20);


rafId = requestAnimationFrame(loop);
}
rafId = requestAnimationFrame(loop);
}


function drawHpBar(player, x, y) {
const barW = 200;
ctx.fillStyle = '#000';
ctx.fillRect(x, y, barW, 18);
ctx.fillStyle = player.color === 'red' ? '#3b82f6' : '#ef4444';
const pct = Math.max(0, player.hp) / 200;
ctx.fillRect(x, y, barW * pct, 18);
ctx.strokeStyle = '#fff';
ctx.strokeRect(x, y, barW, 18);
ctx.fillStyle = '#fff';
ctx.font = '12px sans-serif';
ctx.fillText((player === player1 ? 'Player1' : 'Player2') + ' HP: ' + player.hp, x + 6, y + 14);
}


// If both images already loaded synchronously (browser cache), checkStart will have started loop.
// Otherwise it will start when onload/onerror handlers call checkStart.


// --- INPUT ---
document.addEventListener('keydown', e => {
if (e.key === 'f') { // player1 attack
if (!player1.attacking) {
player1.attacking = true;
player1.attackFrame = 0;
}
}
if (e.key === '/' || e.key === 'j' || e.key === 'J') { // player2 attack (supports / or J)
if (!player2.attacking) {
player2.attacking = true;
player2.attackFrame = 0;
}
}


// simple movement for demo (optional)
if (e.key === 'a') player1.x -= 10;
if (e.key === 'd') player1.x += 10;
if (e.key === 'ArrowLeft') player2.x -= 10;
if (e.key === 'ArrowRight') player2.x += 10;
});


// expose a quick API in console for testing
window._dbg = { player1Img, player2Img, player1, player2 };
</script>
</body>
</html>
